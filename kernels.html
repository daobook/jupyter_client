<!DOCTYPE html>
<html class="writer-html5" lang="zh-CN" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>为 Jupyter 制作内核 &mdash; jupyter_client 7.1.0 文档</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/translations.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="索引" href="genindex.html" />
    <link rel="search" title="搜索" href="search.html" />
    <link rel="next" title="制作简单的 Python 包装器内核" href="wrapperkernels.html" />
    <link rel="prev" title="Jupyter 中的消息传递" href="messaging.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> jupyter_client
          </a>
              <div class="version">
                7.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">用户文档</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="messaging.html">Jupyter 中的消息传递</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">开发者文档</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">为 Jupyter 制作内核</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#connection-files">连接文件</a></li>
<li class="toctree-l2"><a class="reference internal" href="#handling-messages">处理消息</a></li>
<li class="toctree-l2"><a class="reference internal" href="#kernel-specs">内核规范</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="wrapperkernels.html">制作简单的 Python 包装器内核</a></li>
<li class="toctree-l1"><a class="reference internal" href="provisioning.html">Customizing the kernel’s runtime environment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/index.html">jupyter_client API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">变更</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="changelog.html">Changes in Jupyter Client {#changelog}</a></li>
<li class="toctree-l1"><a class="reference internal" href="migration.html">Migration Guide</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">jupyter_client</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>为 Jupyter 制作内核</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/kernels.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="making-kernels-for-jupyter">
<span id="kernels"></span><h1>为 Jupyter 制作内核<a class="headerlink" href="#making-kernels-for-jupyter" title="永久链接至标题">¶</a></h1>
<p>‘内核’ 是一个运行并反省用户代码的程序。IPython 包括一个用于 Python 代码的内核，人们已经为 <a class="reference external" href="https://github.com/jupyter/jupyter/wiki/Jupyter-kernels">其他几种语言编写了内核</a>。</p>
<p>在内核启动时，Jupyter 向内核传递一个连接文件。这指定了如何设置与前端的通信。</p>
<p>编写内核有三种选择：</p>
<ol class="arabic simple">
<li><p>你可以重用 IPython 内核机制来处理通信，而只需描述如何执行你的代码。如果目标语言可以由 Python 驱动，这就简单多了。详情见 <a class="reference internal" href="wrapperkernels.html"><span class="doc">制作简单的 Python 包装器内核</span></a>。</p></li>
<li><p>你可以用你的目标语言实现内核机制。这在最初是比较麻烦的，但是如果使用你的内核的人是用他们熟悉的语言的话，他们可能会更愿意为你的内核做出贡献。</p></li>
<li><p>你可以使用 <a class="reference external" href="https://github.com/jupyter-xeus/xeus">xeus</a> 库，它是 Jupyter 内核协议的 C++ 实现。内核作者只需要在他们的实现中实现特定语言的逻辑（执行代码、自动补全 。。。。。。）。如果你的目标语言可以从 C 或 C++ 驱动，这是最简单的解决方案： 例如，如果它像大多数脚本语言一样有一个 C-API。请查看 <a class="reference external" href="https://xeus.readthedocs.io/">xeus 文档</a> 以了解更多细节。基于 xeus 的内核的例子包括：</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/jupyter-xeus/xeus-cling">xeus-cling</a></p></li>
<li><p><a class="reference external" href="https://github.com/jupyter-xeus/xeus-python">xeus-python</a></p></li>
<li><p><a class="reference external" href="https://github.com/JuniperKernel/JuniperKernel">JuniperKernel</a></p></li>
</ul>
</li>
</ol>
<section id="connection-files">
<h2>连接文件<a class="headerlink" href="#connection-files" title="永久链接至标题">¶</a></h2>
<p>你的内核在启动时将得到一个连接文件的路径（参见 <a class="reference internal" href="#kernelspecs"><span class="std std-ref">内核规范</span></a> 了解如何为你的内核指定命令行参数）。这个文件只有当前用户可以访问，它将包含一个 JSON 字典，看起来像这样</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;control_port&quot;</span><span class="p">:</span> <span class="mi">50160</span><span class="p">,</span>
  <span class="s2">&quot;shell_port&quot;</span><span class="p">:</span> <span class="mi">57503</span><span class="p">,</span>
  <span class="s2">&quot;transport&quot;</span><span class="p">:</span> <span class="s2">&quot;tcp&quot;</span><span class="p">,</span>
  <span class="s2">&quot;signature_scheme&quot;</span><span class="p">:</span> <span class="s2">&quot;hmac-sha256&quot;</span><span class="p">,</span>
  <span class="s2">&quot;stdin_port&quot;</span><span class="p">:</span> <span class="mi">52597</span><span class="p">,</span>
  <span class="s2">&quot;hb_port&quot;</span><span class="p">:</span> <span class="mi">42540</span><span class="p">,</span>
  <span class="s2">&quot;ip&quot;</span><span class="p">:</span> <span class="s2">&quot;127.0.0.1&quot;</span><span class="p">,</span>
  <span class="s2">&quot;iopub_port&quot;</span><span class="p">:</span> <span class="mi">40885</span><span class="p">,</span>
  <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;a0436f6c-1916-498b-8eb9-e81ab9368e84&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">transport</span></code>、<code class="docutils literal notranslate"><span class="pre">ip</span></code> 和五个 <code class="docutils literal notranslate"><span class="pre">_port</span></code> 字段指定了五个端口，内核应该使用 <a class="reference external" href="http://zeromq.org/">ZeroMQ</a> 绑定。例如，在上面的例子中，shell 套接字的地址是</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tcp</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0.0.1</span><span class="p">:</span><span class="mi">57503</span>
</pre></div>
</div>
<p>对于每个启动的内核，新的端口是随机选择的。</p>
<p><code class="docutils literal notranslate"><span class="pre">signature_scheme</span></code> 和 <code class="docutils literal notranslate"><span class="pre">key</span></code> 是用来对信息进行加密签名的，这样系统中的其他用户就不能发送代码到这个内核中运行。请参阅 <a class="reference internal" href="messaging.html#wire-protocol"><span class="std std-ref">The Wire Protocol</span></a>，了解如何计算这个签名的细节。</p>
</section>
<section id="handling-messages">
<h2>处理消息<a class="headerlink" href="#handling-messages" title="永久链接至标题">¶</a></h2>
<p>在读取连接文件并绑定到必要的套接字之后，内核应该进入一个事件循环，监听 hb（heartbeat）、control 和 shell 套接字。</p>
<p><a class="reference internal" href="messaging.html#kernel-heartbeat"><span class="std std-ref">Heartbeat</span></a> 消息应立即在同一套接字上回显 —— 前端使用它来检查内核是否仍然存在。</p>
<p>control 和 shell 套接字上的信息应该被解析，并验证其签名。请参阅 <a class="reference internal" href="messaging.html#wire-protocol"><span class="std std-ref">The Wire Protocol</span></a> 了解如何做到这一点。</p>
<p>内核将在 iopub 套接字上发送消息以显示输出，并在 stdin 套接字上发送消息以提示用户输入文本。</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<dl class="simple">
<dt><a class="reference internal" href="messaging.html"><span class="doc">Jupyter 中的消息传递</span></a></dt><dd><p>不同的套接字和通过它们传递的消息的细节</p>
</dd>
<dt><a class="reference external" href="http://andrew.gibiansky.com/blog/ipython/ipython-kernels/">为 IPython 创建语言内核</a></dt><dd><p><a class="reference external" href="https://github.com/gibiansky/IHaskell">IHaskell</a> 的作者的博文，一个 Haskell 内核</p>
</dd>
<dt><a class="reference external" href="https://github.com/dsblank/simple_kernel">simple_kernel</a></dt><dd><p>用 Python 实现内核机制的一个简单例子</p>
</dd>
</dl>
</div>
</section>
<section id="kernel-specs">
<span id="kernelspecs"></span><h2>内核规范<a class="headerlink" href="#kernel-specs" title="永久链接至标题">¶</a></h2>
<p>一个内核通过创建一个目录来向 IPython 识别自己，该目录的名称被用作内核的标识。这些目录可以在很多地方创建：</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 9%" />
<col style="width: 51%" />
<col style="width: 40%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"></th>
<th class="head"><p>Unix</p></th>
<th class="head"><p>Windows</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>系统</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">/usr/share/jupyter/kernels</span></code></p>
<p><code class="docutils literal notranslate"><span class="pre">/usr/local/share/jupyter/kernels</span></code></p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">%PROGRAMDATA%\jupyter\kernels</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>环境</p></td>
<td colspan="2"><p><code class="docutils literal notranslate"><span class="pre">{sys.prefix}/share/jupyter/kernels</span></code></p></td>
</tr>
<tr class="row-even"><td><p>用户</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">~/.local/share/jupyter/kernels</span></code> (Linux)</p>
<p><code class="docutils literal notranslate"><span class="pre">~/Library/Jupyter/kernels</span></code> (Mac)</p>
</td>
<td><p><code class="docutils literal notranslate"><span class="pre">%APPDATA%\jupyter\kernels</span></code></p></td>
</tr>
</tbody>
</table>
<p>用户位置优先于系统位置，名字的大小写被忽略，所以无论文件系统是否区分大小写，选择内核的方式都是一样的。由于 kernelspecs 出现在 URL 和其他地方，kernelspec 被要求有一个简单的名字，只包含 ASCII 字母、ASCII 数字和简单的分隔符。<code class="docutils literal notranslate"><span class="pre">-</span></code> 连字符，<code class="docutils literal notranslate"><span class="pre">.</span></code> 句点，<code class="docutils literal notranslate"><span class="pre">_</span></code> 下划线。</p>
<p>如果设置了 <span class="target" id="index-2"></span><code class="xref std std-envvar docutils literal notranslate"><span class="pre">JUPYTER_PATH</span></code> 环境变量，也可以搜索其他位置。</p>
<p>在内核目录内，目前有三种类型的文件被使用： <code class="docutils literal notranslate"><span class="pre">kernel.json</span></code>、<code class="docutils literal notranslate"><span class="pre">kernel.js</span></code> 和 logo 图片文件。目前，没有使用其他文件，但将来可能会改变。</p>
<p>在该目录内，最重要的文件是 <em>kernel.json</em>。这应该是一个 JSON 序列化的字典，包含以下键和值：</p>
<ul class="simple">
<li><p><strong>argv</strong>：一个用于启动内核的命令行参数列表。任何参数中的文字 <code class="docutils literal notranslate"><span class="pre">{connection_file}</span></code> 将被替换成连接文件的路径。</p></li>
<li><p><strong>display_name</strong>: 内核的名字，它理应显示在 UI 上。与 API 中使用的内核名称不同，它可以包含任意的 unicode 字符。</p></li>
<li><p><strong>language</strong>：内核的语言名称。当加载笔记本时，如果没有找到匹配的 kernelspec 键（可能在不同的机器上有所不同），将使用具有匹配的 <code class="docutils literal notranslate"><span class="pre">language</span></code> 的内核。这允许在任何 Python 或 Julia 内核上编写的笔记本与用户的 Python 或 Julia 内核正确关联，即使它们与作者的内核不在同一名称下。</p></li>
<li><p><strong>interrupt_mode</strong> （可选）：可以是 <code class="docutils literal notranslate"><span class="pre">signal</span></code> 或 <code class="docutils literal notranslate"><span class="pre">message</span></code>，指定客户如何中断该内核上的单元执行，可以通过操作系统的信号设施（例如 POSIX 系统上的 <cite>SIGINT</cite>）发送一个中断 <code class="docutils literal notranslate"><span class="pre">signal</span></code>，或者在控制通道上发送一个 <code class="docutils literal notranslate"><span class="pre">interrupt_request</span></code> 消息（见 <a class="reference internal" href="messaging.html#msging-interrupt"><span class="std std-ref">Kernel interrupt</span></a>）。如果没有指定，客户端将默认为 <code class="docutils literal notranslate"><span class="pre">signal</span></code> 模式”</p></li>
<li><p><strong>env</strong> （可选）：一个为内核设置的环境变量字典。这些将在内核启动前被添加到当前的环境变量中。现有的环境变量可以用 <code class="docutils literal notranslate"><span class="pre">${&lt;ENV_VAR&gt;}</span></code> 来引用，并将被替换成相应的值。管理员应该注意，使用 <code class="docutils literal notranslate"><span class="pre">${&lt;ENV_VAR&gt;}</span></code> 可能会暴露敏感变量，应该只在受控情况下使用。</p></li>
<li><p><strong>metadata</strong> （可选）：关于这个内核的额外属性的字典；被客户用来帮助选择内核。在这里添加的元数据应该为读取和写入该元数据的工具命名。</p></li>
</ul>
<p>例如，IPython 的 kernel.json 文件是这样的</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
 <span class="s2">&quot;argv&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;python3&quot;</span><span class="p">,</span> <span class="s2">&quot;-m&quot;</span><span class="p">,</span> <span class="s2">&quot;IPython.kernel&quot;</span><span class="p">,</span>
          <span class="s2">&quot;-f&quot;</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">{connection_file}</span><span class="s2">&quot;</span><span class="p">],</span>
 <span class="s2">&quot;display_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Python 3&quot;</span><span class="p">,</span>
 <span class="s2">&quot;language&quot;</span><span class="p">:</span> <span class="s2">&quot;python&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>要查看可用的内核规格，运行</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jupyter</span> <span class="n">kernelspec</span> <span class="nb">list</span>
</pre></div>
</div>
<p>用一个特定的内核来启动终端控制台或 Qt 控制台</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">jupyter</span> <span class="n">console</span> <span class="o">--</span><span class="n">kernel</span> <span class="n">bash</span>
<span class="n">jupyter</span> <span class="n">qtconsole</span> <span class="o">--</span><span class="n">kernel</span> <span class="n">bash</span>
</pre></div>
</div>
<p>notebook 在 ‘New’ 按钮的下拉菜单中为你提供可用的内核。</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="messaging.html" class="btn btn-neutral float-left" title="Jupyter 中的消息传递" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="wrapperkernels.html" class="btn btn-neutral float-right" title="制作简单的 Python 包装器内核" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; 版权所有 2015, Jupyter Development Team.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>